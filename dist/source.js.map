{"version":3,"sources":["../src/source.js"],"names":[],"mappings":"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","file":"source.js","sourcesContent":["import Player from './player';\n\nexport default class Source extends Player {\n  constructor(rootNodeOrSelector, collectionSelector = 'article', itemSelector = 'section') {\n    super(rootNodeOrSelector);\n\n    document.addEventListener('selectionchange', this.onSelectionChange.bind(this));\n    document.addEventListener('mouseup', this.onMouseUp.bind(this));\n  }\n\n  onSelectionChange() {\n    const selection = window.getSelection();\n    if (selection.rangeCount === 0) return;\n\n    const range = selection.getRangeAt(0);\n    const commonAncestor = range.commonAncestorContainer;\n\n    if (commonAncestor.nodeType === document.TEXT_NODE) {\n      range.setStartBefore(commonAncestor.parentNode);\n      return;\n    }\n\n    if (!(commonAncestor.matches('section[data-src]') || commonAncestor.parentNode.matches('section[data-src]'))) return;\n\n    for (const selected of this.root.querySelectorAll('.selected')) {\n      if (selection.containsNode(selected, true) || selection.containsNode(selected.parentNode, true)) continue;\n      selected.classList.remove('selected');\n      selected.removeAttribute('draggable');\n    }\n\n    for (const candidate of commonAncestor.getElementsByTagName('*')) {\n      if (selection.containsNode(candidate, true) && candidate.nodeName !== 'P') {\n        candidate.classList.add('selected');\n      }\n    }\n  }\n\n  onMouseUp() {\n    const selection = window.getSelection();\n    const selected = this.root.querySelectorAll('.selected');\n\n    for (const node of selected) {\n      if (selection.containsNode(node, true) || selection.containsNode(node.parentNode, true)) {\n        node.setAttribute('draggable', true);\n        node.addEventListener('dragstart', this.onDragStart.bind(this));\n        // node.addEventListener('dragend', this.onDragEnd.bind(this));\n      } else {\n        // console.log('kill', node);\n        node.classList.remove('selected');\n        node.removeAttribute('draggable');\n      }\n    }\n\n    if (selected.length > 0 && selection.rangeCount > 0) {\n      const range = selection.getRangeAt(0);\n      range.setStartBefore(selected.item(0));\n      range.setEndAfter(selected.item(selected.length - 1));\n    } else {\n      selection.removeAllRanges();\n    }\n  }\n\n  onDragStart(event) {\n    // event.preventDefault();\n    // event.stopPropagation();\n\n    const item = document.createElement('section');\n    for (const selected of this.root.querySelectorAll('.selected')) {\n      const clone = selected.cloneNode(true);\n      clone.classList.remove('selected');\n      clone.removeAttribute('draggable');\n      item.appendChild(clone);\n    }\n\n    event.dataTransfer.setData('html', item.outerHTML);\n    event.dataTransfer.effectAllowed = 'copy';\n    event.dataTransfer.dropEffect = 'copy';\n\n    // return false;\n  }\n\n  // onDragEnd() {\n  //   for (const node of this.node.querySelectorAll('.selected')) {\n  //     node.classList.remove('selected');\n  //     node.removeAttribute('draggable');\n  //   }\n  // }\n}\n"]}